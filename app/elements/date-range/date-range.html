<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-input/iron-input.html">
<link rel="import" href="../../bower_components/iron-form-element-behavior/iron-form-element-behavior.html">
<link rel="import" href="../../bower_components/iron-validatable-behavior/iron-validatable-behavior.html">
<link rel="import" href="../../bower_components/paper-input/paper-input-container.html">
<link rel="import" href="../../bower_components/paper-input/paper-input-error.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../datetime-input/datetime-input.html">

<dom-module id="date-range">
  <template>
    <datetime-input inputId="startDate" name="startDate" label="start date" datetime="{{startDateTime}}" date="{{startDate}}" time="{{startTime}}" required></datetime-input>
    <datetime-input id="end" inputId="endDate" name="endDate" label="end date" datetime="{{endDateTime}}" date="{{endDate}}" time="{{endTime}}" required></datetime-input>
  </template>

</dom-module>
<script>
 (function() {
   'use-strict';

   Polymer({
     is: 'date-range',

     behaviors: [
       Polymer.IronFormElementBehavior,
       Polymer.IronValidatableBehavior
     ],

     properties: {
       startDateTime: {
         value: function() {
           return app.nowDateTime();
         },
         notify: true
       },
       startDate: {
         value: function() {
           return app.nowDate();
         },
         notify: true
       },
       startTime: {
         value: function() {
           return app.nowTime();
         },
         notify: true
       },
       endDateTime: {
         value: function() {
           return app.laterDateTime();
         },
         notify: true
       },
       endDate: {
         value: function() {
           return app.nowDate();
         },
         notify: true
       },
       endTime: {
         value: function() {
           return app.laterTime();
         },
         notify: true
       },
       start: {
         type: String,
         value: function() {
           return app.nowDateTime();
         },
         notify: true
       },
       end: {
         type: String,
         value: function() {
           return app.laterDateTime();
         },
         notify: true
       }
     },

     listeners: {
       'end.change': '_getValidity'
     },

     dateSupported: function() {
       return Modernizr.inputtypes['datetime-local'];
     },

     // normalizes the dates to the datetime-local format
     normalizeDate: function(date, time) {
       date = moment(date, "MM/DD/YYYY").format("YYYY-MM-DD");
       time = moment(time, "hh:mm a").format("HH:mm:ss");
       return date + "T" + time;
     },

     _getValidity: function() {
       this.start = this.dateSupported() ? this.startDateTime : this.normalizeDate(this.startDate, this.startTime),
       this.end = this.dateSupported() ? this.endDateTime : this.normalizeDate(this.endDate, this.endTime);

       var diff = diff = moment(this.start).diff(this.end);

       // get every date input (there can be datetime-local or date and time)
       var children = this.$.end.children;
       var endEl;
       for (var i = 0; i < children.length; i++) {
         if (children[i].dataset.hidden) {
           endEl = children[i].children[0];
         }
       }

       if (diff >= 0) {
         endEl.setAttribute('error-message', "start date must be before end date");
         endEl.setAttribute('invalid', true);
         return false;
       } else {
         endEl.removeAttribute('invalid');
         return true;
       }
     }

   })
 })();
</script>
